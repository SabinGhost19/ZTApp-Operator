apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: zerotrustsecrets.devsecops.licenta.ro
spec:
  group: devsecops.licenta.ro
  names:
    kind: ZeroTrustSecret
    plural: zerotrustsecrets
    singular: zerotrustsecret
    shortNames:
      - zts
  scope: Namespaced
  versions:
    - name: v1
      served: true
      storage: true
      schema:
        openAPIV3Schema:
          type: object
          properties:
            spec:
              type: object
              required:
                - targetWorkload
                - secretData
              properties:
                targetWorkload:
                  type: object
                  required: [kind, name]
                  properties:
                    kind:
                      type: string
                      enum: [Deployment, StatefulSet, DaemonSet]
                    name:
                      type: string
                    namespace:
                      type: string
                secretStoreRef:
                  type: object
                  properties:
                    kind:
                      type: string
                      default: ClusterSecretStore
                    name:
                      type: string
                      default: vault-backend
                targetSecretName:
                  type: string
                secretData:
                  type: object
                  required: [remotePath, mapping]
                  properties:
                    remotePath:
                      type: string
                    mapping:
                      type: array
                      minItems: 1
                      items:
                        type: object
                        required: [remoteKey, localKey, type]
                        properties:
                          remoteKey:
                            type: string
                          localKey:
                            type: string
                          type:
                            type: string
                            enum: [EnvVar, VolumeMount]
                          mountPath:
                            type: string
                zeroTrustConditions:
                  type: object
                  properties:
                    requireCleanSupplyChain:
                      type: boolean
                      default: true
                    maxAllowedVulnerability:
                      type: string
                      enum: [Low, Medium, High, Critical]
                    requireNetworkIsolation:
                      type: boolean
                      default: true
                    timeBasedAccess:
                      type: object
                      properties:
                        enabled:
                          type: boolean
                          default: false
                lifecycle:
                  type: object
                  properties:
                    refreshInterval:
                      type: string
                      default: 10m
                    onUpdateAction:
                      type: string
                      enum: [RollingRestart]
                      default: RollingRestart
            status:
              type: object
              properties:
                phase:
                  type: string
                lastError:
                  type: string
                targetSecretName:
                  type: string
                lastRotationChecksum:
                  type: string
      subresources:
        status: {}
      additionalPrinterColumns:
        - name: Phase
          type: string
          jsonPath: .status.phase
        - name: Target
          type: string
          jsonPath: .spec.targetWorkload.name
